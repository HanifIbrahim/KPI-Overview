<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Lidl Analysis — Live Dashboard (Google Sheets)</title>

  <!-- Tailwind (CDN) -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Simple CSS (no @apply so it works with the CDN) -->
  <style>
    .card { border-radius: 1rem; box-shadow: 0 10px 16px rgba(0,0,0,.06); background:#fff; padding:1.25rem; }
    .metric { font-size:1.5rem; font-weight:600; }
    .metric-label { font-size:.9rem; color:#6b7280; }
  </style>

  <!-- React & ReactDOM (UMD) -->
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>

  <!-- Recharts (UMD) -->
  <script crossorigin src="https://unpkg.com/recharts/umd/Recharts.min.js"></script>

  <!-- Day.js -->
  <script src="https://unpkg.com/dayjs@1/dayjs.min.js"></script>
  <script src="https://unpkg.com/dayjs@1/plugin/utc.js"></script>
  <script src="https://unpkg.com/dayjs@1/plugin/timezone.js"></script>
  <script>dayjs.extend(dayjs_plugin_utc); dayjs.extend(dayjs_plugin_timezone);</script>

  <!-- PapaParse for CSV -->
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

  <!-- Babel for inline JSX -->
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
</head>
<body class="bg-gray-50 min-h-screen">
  <div id="root"></div>

  <script type="text/babel" data-presets="env,react">
    const {
      AreaChart, Area, BarChart, Bar, PieChart, Pie, Cell, XAxis, YAxis, CartesianGrid, Tooltip, ResponsiveContainer, Legend, ScatterChart, Scatter
    } = Recharts;

    // === CONFIG: paste your Published CSV URLs here ===
    // Get them from Google Sheets: File → Share → Publish to web → link → pick the tab → CSV
    const SALES_CSV_URL = 'PASTE_PUBLISHED_CSV_URL_FOR_SALES_OR_COMBINED_HERE';
    const LABOR_CSV_URL = null; // set to another CSV if you split sales/labor
    const POLL_MS = 60000; // re-fetch every 60s; set 0 to disable

    // ---- helpers ----
    const fmt = new Intl.NumberFormat('en-US');
    const money = v => (v == null || isNaN(v) ? '—' : '$' + fmt.format(Number(v).toFixed(0)));
    const num = (v, d=0) => (v == null || isNaN(v) ? '—' : fmt.format(Number(v).toFixed(d)));
    const pct = (v, d=1) => (v == null || isNaN(v) ? '—' : (v>=0?'+':'') + Number(v).toFixed(d) + '%');

    const toN = x => {
      if (x == null) return null;
      const s = String(x).replace(/,/g,'').trim();
      const n = Number(s);
      return isNaN(n) ? null : n;
    };

    const groupBy = (rows, keyFn) => rows.reduce((acc, r) => { const k = keyFn(r); (acc[k] ||= []).push(r); return acc; }, {});
    const sum = (arr, sel) => arr.reduce((t, r) => t + (toN(sel(r)) || 0), 0);
    const unique = arr => [...new Set(arr)];
    const normalizeHeader = h => (h||'').trim().replace(/\s+/g,' ').replace(/[“”]/g,'"');

    function pick(row, keys) {
      for (const k of keys) if (k in row && row[k] !== '') return row[k];
      const norm = Object.keys(row).reduce((m, kk) => (m[normalizeHeader(kk)] = kk, m), {});
      for (const k of keys) { const n = normalizeHeader(k); if (n in norm) return row[norm[n]]; }
      return null;
    }

    function mergeOnDateDept(a, b) {
      const key = r => `${pick(r, ['Date','DATE'])}||${pick(r, ['Department','DEPARTMENT'])||''}`;
      const map = new Map();
      a.forEach(r => map.set(key(r), { ...r }));
      b.forEach(r => { const k = key(r); map.set(k, { ...(map.get(k)||{}), ...r }); });
      return [...map.values()];
    }

    function fetchCSV(url){
      return new Promise((resolve, reject) => {
        if (!url) return resolve([]);
        Papa.parse(url, {
          download: true, header: true, skipEmptyLines: true,
          complete: res => resolve(res.data || []),
          error: reject
        });
      });
    }

    function App(){
      const [loading, setLoading] = React.useState(true);
      const [error, setError] = React.useState(null);
      const [rows, setRows] = React.useState([]);

      const [dateFrom, setDateFrom] = React.useState(dayjs().subtract(30,'day').format('YYYY-MM-DD'));
      const [dateTo,   setDateTo]   = React.useState(dayjs().format('YYYY-MM-DD'));
      const [dept, setDept] = React.useState('All');
      const [groupByPeriod, setGroupByPeriod] = React.useState('day'); // 'day' | 'week'

      const load = React.useCallback(async ()=>{
        setLoading(true); setError(null);
        try{
          const sales = await fetchCSV(SALES_CSV_URL);
          const labor = await fetchCSV(LABOR_CSV_URL);
          const merged = LABOR_CSV_URL ? mergeOnDateDept(sales, labor) : sales;

          const norm = merged.map(r => {
            const dateStr = pick(r, ['Date','DATE','date']);
            const deptStr = pick(r, ['Department','DEPARTMENT','dept','Area']);
            const d = dayjs(dateStr).isValid() ? dayjs(dateStr).toISOString() : null;
            return {
              Date: d,
              Department: deptStr || 'Unspecified',
              'Sales ($)': toN(pick(r, ['Sales ($)','Sales$','Sales','Total Sales'])),
              'Sales Quantity (Units/2.2 lbs)': toN(pick(r, ['Sales Quantity (Units/2.2 lbs)','Sales Quantity','Units'])),
              'Sales Quantity': toN(pick(r, ['Sales Quantity','Units'])),
              'Customers': toN(pick(r, ['Customers','Customer Count'])),
              'Net Hours': toN(pick(r, ['Net Hours','Hours'])),
              'Net Hours PEP': toN(pick(r, ['Net Hours PEP','PEP Hours','Target Hours'])),
              'Additional Hours': toN(pick(r, ['Additional Hours','Add Hours'])),
              'Net Hours ∆ PEP': toN(pick(r, ['Net Hours ∆ PEP','Net Hours Delta PEP','Hours Delta PEP'])),
              id: `${dateStr}::${deptStr || ''}`,
            };
          }).filter(r => r.Date);

          norm.sort((a,b)=> new Date(a.Date) - new Date(b.Date));
          setRows(norm);
        }catch(err){ console.error(err); setError(err.message || String(err)); }
        finally{ setLoading(false); }
      },[]);

      React.useEffect(()=>{ load(); }, [load]);
      React.useEffect(()=>{ if(!POLL_MS) return; const t=setInterval(load, POLL_MS); return ()=>clearInterval(t); }, [load]);

      const departments = React.useMemo(()=> ['All', ...unique(rows.map(r => r.Department || 'Unspecified'))], [rows]);

      const dateFiltered = React.useMemo(()=>{
        const from = dayjs(dateFrom).startOf('day'); const to = dayjs(dateTo).endOf('day');
        return rows.filter(r => { const d = dayjs(r.Date); return d.isAfter(from.subtract(1,'ms')) && d.isBefore(to.add(1,'ms')); });
      }, [rows, dateFrom, dateTo]);

      const filtered = React.useMemo(()=> dateFiltered.filter(r => (dept === 'All' || (r.Department || 'Unspecified') === dept)), [dateFiltered, dept]);

      const kpis = React.useMemo(()=>{
        if(!filtered.length) return null;
        const sales = sum(filtered, r => r['Sales ($)']);
        const units = sum(filtered, r => r['Sales Quantity (Units/2.2 lbs)'] ?? r['Sales Quantity']);
        const hours = sum(filtered, r => r['Net Hours']);
        const pepHours = sum(filtered, r => r['Net Hours PEP']);
        const prod = hours ? units / hours : null;
        const hoursDeltaPct = pepHours ? ((hours - pepHours) / pepHours) * 100 : null;
        const customers = sum(filtered, r => r['Customers']);
        const basket = customers ? sales / customers : null;
        return { sales, units, hours, prod, hoursDeltaPct, customers, basket };
      }, [filtered]);

      const tsData = React.useMemo(()=>{
        const byKey = groupBy(filtered, r => {
          const d = dayjs(r.Date);
          return groupByPeriod === 'week' ? d.startOf('week').format('YYYY-MM-DD') : d.format('YYYY-MM-DD');
        });
        return Object.entries(byKey).map(([k, arr]) => ({
          period: k,
          sales: sum(arr, r => r['Sales ($)']),
          units: sum(arr, r => r['Sales Quantity (Units/2.2 lbs)'] ?? r['Sales Quantity']),
          hours: sum(arr, r => r['Net Hours']),
          prod: (sum(arr, r => r['Net Hours']) ? sum(arr, r => r['Sales Quantity (Units/2.2 lbs)'] ?? r['Sales Quantity']) / sum(arr, r => r['Net Hours']) : 0)
        })).sort((a,b)=> new Date(a.period) - new Date(b.period));
      }, [filtered, groupByPeriod]);

      const pieData = React.useMemo(()=>{
        const byDept = groupBy(filtered, r => r.Department || 'Unspecified');
        return Object.entries(byDept).map(([k, arr]) => ({ name: k, value: sum(arr, r => r['Sales ($)']) }))
          .sort((a,b)=> b.value - a.value);
      }, [filtered]);

      return (
        <div className="max-w-7xl mx-auto p-4 md:p-6">
          <header className="flex flex-col md:flex-row items-start md:items-center justify-between gap-4 mb-6">
            <div>
              <h1 className="text-2xl md:text-3xl font-bold">Lidl Analysis — Live Dashboard</h1>
              <p className="text-gray-600">Pulls from Google Sheets (Published CSV). Auto-syncs every {POLL_MS/1000}s or on refresh.</p>
            </div>
            <a href="#setup" className="text-sm text-blue-600 underline">Setup guide ↓</a>
          </header>

          <section className="card mb-6">
            <div className="grid grid-cols-2 md:grid-cols-5 gap-4 items-end">
              <div>
                <label className="block text-sm text-gray-600 mb-1">From</label>
                <input type="date" value={dateFrom} onChange={e=>setDateFrom(e.target.value)} className="w-full border rounded-lg p-2" />
              </div>
              <div>
                <label className="block text-sm text-gray-600 mb-1">To</label>
                <input type="date" value={dateTo} onChange={e=>setDateTo(e.target.value)} className="w-full border rounded-lg p-2" />
              </div>
              <div>
                <label className="block text-sm text-gray-600 mb-1">Department</label>
                <select className="w-full border rounded-lg p-2" value={dept} onChange={e=>setDept(e.target.value)}>
                  {departments.map(d => <option key={d} value={d}>{d}</option>)}
                </select>
              </div>
              <div>
                <label className="block text-sm text-gray-600 mb-1">Group by</label>
                <select className="w-full border rounded-lg p-2" value={groupByPeriod} onChange={e=>setGroupByPeriod(e.target.value)}>
                  <option value="day">Day</option>
                  <option value="week">Week</option>
                </select>
              </div>
              <div className="text-right">
                <button onClick={()=>location.reload()} className="px-4 py-2 rounded-xl border hover:bg-gray-50">Sync now</button>
              </div>
            </div>
          </section>

          {error && (
            <div className="mb-4 bg-rose-50 text-rose-700 border border-rose-200 rounded-xl p-3">
              <strong>Error:</strong> {error}
            </div>
          )}

          <section className="grid grid-cols-1 md:grid-cols-3 lg:grid-cols-6 gap-4 mb-6">
            <div className="card"><div className="metric">{kpis ? money(kpis.sales) : '—'}</div><div className="metric-label">Sales</div></div>
            <div className="card"><div className="metric">{kpis ? num(kpis.units) : '—'}</div><div className="metric-label">Units</div></div>
            <div className="card"><div className="metric">{kpis ? num(kpis.hours,1) : '—'}</div><div className="metric-label">Net Hours</div></div>
            <div className="card"><div className="metric">{kpis && kpis.prod!=null ? num(kpis.prod,2) : '—'}</div><div className="metric-label">Productivity (Units/Hour)</div></div>
            <div className="card"><div className="metric">{kpis && kpis.hoursDeltaPct!=null ? pct(kpis.hoursDeltaPct) : '—'}</div><div className="metric-label">Net Hours Δ vs PEP</div></div>
            <div className="card"><div className="metric">{kpis && kpis.basket!=null ? money(kpis.basket) : '—'}</div><div className="metric-label">Avg Basket</div></div>
          </section>

          <section className="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
            <div className="card h-80">
              <h3 className="font-semibold mb-3">Sales over time</h3>
              <ResponsiveContainer width="100%" height="100%">
                <AreaChart data={tsData} margin={{ top: 10, right: 20, bottom: 0, left: 0 }}>
                  <defs>
                    <linearGradient id="colorSales" x1="0" y1="0" x2="0" y2="1">
                      <stop offset="5%" stopColor="#3b82f6" stopOpacity={0.35}/>
                      <stop offset="95%" stopColor="#3b82f6" stopOpacity={0}/>
                    </linearGradient>
                  </defs>
                  <CartesianGrid strokeDasharray="3 3" />
                  <XAxis dataKey="period" />
                  <YAxis />
                  <Tooltip formatter={(v)=> money(v)} />
                  <Area type="monotone" dataKey="sales" stroke="#3b82f6" fillOpacity={1} fill="url(#colorSales)" />
                </AreaChart>
              </ResponsiveContainer>
            </div>
            <div className="card h-80">
              <h3 className="font-semibold mb-3">Units vs Hours (Productivity)</h3>
              <ResponsiveContainer width="100%" height="100%">
                <ScatterChart margin={{ top: 10, right: 20, bottom: 0, left: 0 }}>
                  <CartesianGrid strokeDasharray="3 3" />
                  <XAxis dataKey="hours" name="Hours" />
                  <YAxis dataKey="units" name="Units" />
                  <Tooltip cursor={{ strokeDasharray: '3 3' }} />
                  <Legend />
                  <Scatter name="Daily" data={tsData.map(d=>({ hours:d.hours, units:d.units }))} fill="#10b981" />
                </ScatterChart>
              </ResponsiveContainer>
            </div>
            <div className="card h-80">
              <h3 className="font-semibold mb-3">Net Hours by period</h3>
              <ResponsiveContainer width="100%" height="100%">
                <BarChart data={tsData}>
                  <CartesianGrid strokeDasharray="3 3" />
                  <XAxis dataKey="period" />
                  <YAxis />
                  <Tooltip />
                  <Bar dataKey="hours" fill="#6366f1" />
                </BarChart>
              </ResponsiveContainer>
            </div>
            <div className="card h-80">
              <h3 className="font-semibold mb-3">Sales share by Department</h3>
              <ResponsiveContainer width="100%" height="100%">
                <PieChart>
                  <Tooltip formatter={(v)=> money(v)} />
                  <Legend />
                  <Pie data={pieData} dataKey="value" nameKey="name" outerRadius={110}>
                    {pieData.map((entry, index) => (<Cell key={`cell-${index}`} />))}
                  </Pie>
                </PieChart>
              </ResponsiveContainer>
            </div>
          </section>

          <section className="card mb-10 overflow-x-auto">
            <h3 className="font-semibold mb-3">Recent rows</h3>
            <table className="min-w-full text-sm">
              <thead className="text-left text-gray-600">
                <tr>
                  <th className="py-2 pr-4">Date</th>
                  <th className="py-2 pr-4">Department</th>
                  <th className="py-2 pr-4">Sales ($)</th>
                  <th className="py-2 pr-4">Units</th>
                  <th className="py-2 pr-4">Net Hours</th>
                  <th className="py-2 pr-4">Net Hours PEP</th>
                  <th className="py-2 pr-4">Δ Hours vs PEP</th>
                </tr>
              </thead>
              <tbody>
                {loading ? (
                  <tr><td className="py-6 text-gray-500" colSpan="7">Loading…</td></tr>
                ) : (filtered.length ? filtered.slice(-25).map(r => (
                  <tr key={r.id} className="border-t">
                    <td className="py-2 pr-4">{dayjs(r.Date).format('YYYY-MM-DD')}</td>
                    <td className="py-2 pr-4">{r.Department || '—'}</td>
                    <td className="py-2 pr-4">{money(toN(r['Sales ($)']))}</td>
                    <td className="py-2 pr-4">{num(toN(r['Sales Quantity (Units/2.2 lbs)'] ?? r['Sales Quantity']))}</td>
                    <td className="py-2 pr-4">{num(toN(r['Net Hours']),1)}</td>
                    <td className="py-2 pr-4">{num(toN(r['Net Hours PEP']),1)}</td>
                    <td className="py-2 pr-4">{(() => { const a = toN(r['Net Hours']); const b = toN(r['Net Hours PEP']); if (!a || !b) return '—'; return pct(((a-b)/b)*100,1); })()}</td>
                  </tr>
                )) : (
                  <tr><td className="py-6 text-gray-500" colSpan="7">No rows in this range.</td></tr>
                ))}
              </tbody>
            </table>
          </section>

          <section id="setup" className="card prose max-w-none">
            <h2 className="text-xl font-semibold">Setup (Google Sheets — free)</h2>
            <ol className="list-decimal pl-5">
              <li><strong>Prepare your Sheets.</strong> Keep columns like <code>Date</code>, <code>Department</code>, <code>Sales ($)</code>, <code>Sales Quantity (Units/2.2 lbs)</code>, <code>Customers</code>, <code>Net Hours</code>, <code>Net Hours PEP</code>. One tab or two tabs is fine.</li>
              <li><strong>Publish to CSV.</strong> File → Share → Publish to web → choose the tab → format: CSV. Paste the URL(s) into the constants at the top of this file.</li>
              <li><strong>Deploy.</strong> Save as <code>index.html</code> and host on GitHub Pages / Netlify / Vercel.</li>
              <li><strong>Updates.</strong> Edits in Sheets update the published CSV within seconds; this page re-fetches every {POLL_MS/1000}s or when you click “Sync now”.</li>
            </ol>
          </section>

          <footer className="mt-10 text-center text-sm text-gray-500 pb-8">© <span id="yr"></span> Lidl Analysis — Portfolio Dashboard</footer>
        </div>
      );
    }

    function Root(){ React.useEffect(()=>{ document.getElementById('yr').textContent = new Date().getFullYear(); }, []); return <App/>; }
    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<Root/>);
  </script>
</body>
</html>
