<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Lidl Dashboard — Sheets &amp; R Analysis</title>

    <!-- Tailwind for styling (no build step needed) -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Simple CSS overrides -->
    <style>
      .card { border-radius: 1rem; box-shadow: 0 10px 16px rgba(0,0,0,.06); background:#fff; padding:1.25rem; }
      .metric { font-size:1.5rem; font-weight:600; }
      .metric-label { font-size:.9rem; color:#6b7280; }
    </style>

    <!-- React & ReactDOM (UMD builds) -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>

    <!-- Recharts for charts -->
    <script crossorigin src="https://unpkg.com/recharts/umd/Recharts.min.js"></script>

    <!-- Day.js and plugins (for dates) -->
    <script src="https://unpkg.com/dayjs@1/dayjs.min.js"></script>
    <script src="https://unpkg.com/dayjs@1/plugin/utc.js"></script>
    <script src="https://unpkg.com/dayjs@1/plugin/timezone.js"></script>
    <script>dayjs.extend(dayjs_plugin_utc); dayjs.extend(dayjs_plugin_timezone);</script>

    <!-- PapaParse for CSV parsing -->
    <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

    <!-- Babel for inline JSX + support for advanced syntax -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  </head>
  <body class="bg-gray-50 min-h-screen">
    <div id="root"></div>

    <!--
      Dashboard logic.
      Replace RAW_CSV_URL and ANALYSIS_CSV_URL below with your published Google Sheets CSV links.
      RAW_CSV_URL: The combined daily data (Date, Department, Sales, etc.).
      ANALYSIS_CSV_URL: Optional – results from your R analysis (e.g. Sales Forecast, Overstaffed Prob). Leave null if not used.
      Both sheets must be published to the web as CSV (File → Share → Publish to web).
    -->
    <script type="text/babel" data-presets="env,react" data-plugins="proposal-nullish-coalescing-operator,proposal-optional-chaining">
      const {
        AreaChart, Area, BarChart, Bar, PieChart, Pie, Cell, XAxis, YAxis, CartesianGrid, Tooltip, ResponsiveContainer, Legend,
        ScatterChart, Scatter, Line
      } = Recharts;

      // === CONFIG ===
      const RAW_CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vSxo6dLzN23KhiDNUEKL76_nzALDs9utPshKMLszuxGqED1QjUMAt6A0yLse0inI5LsSVfCBO_cegvt/pub?output=csv";
      const ANALYSIS_CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vSxo6dLzN23KhiDNUEKL76_nzALDs9utPshKMLszuxGqED1QjUMAt6A0yLse0inI5LsSVfCBO_cegvt/pub?gid=1150923660&single=true&output=csv"; // set to null if you don't have a model output
      const POLL_MS = 60000; // auto-refresh every 60s; 0 to disable

      // Format helpers
      const fmt = new Intl.NumberFormat('en-US');
      const money = v => v == null || isNaN(v) ? '—' : '$' + fmt.format(Number(v).toFixed(0));
      const num = (v, d=0) => v == null || isNaN(v) ? '—' : fmt.format(Number(v).toFixed(d));
      const pct = (v, d=1) => v == null || isNaN(v) ? '—' : (v >= 0 ? '+' : '') + Number(v).toFixed(d) + '%';

      const toNumber = x => {
        if (x === undefined || x === null) return null;
        const s = String(x).replace(/,/g, '').trim();
        const n = Number(s);
        return isNaN(n) ? null : n;
      };

      // Group by key function
      const groupBy = (rows, keyFn) => rows.reduce((acc, r) => {
        const k = keyFn(r);
        (acc[k] ||= []).push(r);
        return acc;
      }, {});

      const sum = (arr, sel) => arr.reduce((total, r) => total + (toNumber(sel(r)) || 0), 0);
      const unique = arr => [...new Set(arr)];

      // Normalize header keys (trim spaces, unify quotes)
      const normalizeHeader = h => (h || '').trim().replace(/\s+/g, ' ').replace(/[“”]/g, '"');

      /**
       * Pick the first non-empty value from possible keys (case insensitive, trimmed).
       * @param {object} row
       * @param {string[]} keys
       */
      function pick(row, keys) {
        for (const k of keys) {
          if (k in row && row[k] !== '') return row[k];
        }
        const norm = Object.keys(row).reduce((m, kk) => {
          m[normalizeHeader(kk)] = kk;
          return m;
        }, {});
        for (const k of keys) {
          const n = normalizeHeader(k);
          if (n in norm) return row[norm[n]];
        }
        return null;
      }

      /**
       * Merge two arrays of records on Date + Department keys. Records in b override values from a when keys collide.
       * @param {Array} a
       * @param {Array} b
       */
      function mergeOnDateDept(a, b) {
        const key = r => `${pick(r, ['Date','DATE'])}||${pick(r, ['Department','DEPARTMENT']) || ''}`;
        const map = new Map();
        a.forEach(r => map.set(key(r), { ...r }));
        b.forEach(r => {
          const k = key(r);
          map.set(k, { ...(map.get(k) || {}), ...r });
        });
        return [...map.values()];
      }

      /**
       * Fetch a CSV file and return an array of objects (rows).
       * @param {string|null} url
       */
      function fetchCSV(url) {
        return new Promise((resolve, reject) => {
          if (!url) return resolve([]);
          Papa.parse(url, {
            download: true,
            header: true,
            skipEmptyLines: true,
            complete: (results) => resolve(results.data || []),
            error: reject
          });
        });
      }

      function App() {
        // State hooks
        const [loading, setLoading] = React.useState(true);
        const [error, setError] = React.useState(null);
        const [rows, setRows] = React.useState([]);
        // UI filters
        const [dateFrom, setDateFrom] = React.useState(() => dayjs().subtract(30, 'day').format('YYYY-MM-DD'));
        const [dateTo, setDateTo] = React.useState(() => dayjs().format('YYYY-MM-DD'));
        const [dept, setDept] = React.useState('All');
        const [groupByPeriod, setGroupByPeriod] = React.useState('day'); // 'day' or 'week'

        // Data loading function
        const load = React.useCallback(async () => {
          setLoading(true);
          setError(null);
          try {
            const raw = await fetchCSV(RAW_CSV_URL);
            const analysis = await fetchCSV(ANALYSIS_CSV_URL);
            // If analysis exists, merge on date+dept
            const merged = analysis.length ? mergeOnDateDept(raw, analysis) : raw;
            // Normalize and cast values
            const normalized = merged.map(record => {
              const dateStr = pick(record, ['Date','DATE','date']);
              const deptStr = pick(record, ['Department','DEPARTMENT','dept','Area']);
              const iso = dayjs(dateStr).isValid() ? dayjs(dateStr).toISOString() : null;
              return {
                Date: iso,
                Department: deptStr || 'Unspecified',
                'Sales ($)': toNumber(pick(record, ['Sales ($)','Sales$','Sales','Total Sales'])),
                'Sales Quantity (Units/2.2 lbs)': toNumber(pick(record, ['Sales Quantity (Units/2.2 lbs)','Sales Quantity','Units'])),
                'Sales Quantity': toNumber(pick(record, ['Sales Quantity','Units'])),
                'Customers': toNumber(pick(record, ['Customers','Customer Count'])),
                'Net Hours': toNumber(pick(record, ['Net Hours','Hours'])),
                'Net Hours PEP': toNumber(pick(record, ['Net Hours PEP','PEP Hours','Target Hours'])),
                'Additional Hours': toNumber(pick(record, ['Additional Hours','Add Hours'])),
                'Net Hours ∆ PEP': toNumber(pick(record, ['Net Hours ∆ PEP','Net Hours Delta PEP','Hours Delta PEP'])),
                // Analysis fields (may be undefined)
                'Sales Forecast': toNumber(pick(record, ['Sales Forecast','Forecast','Sales_Forecast'])),
                'Overstaffed Prob': toNumber(pick(record, ['Overstaffed Prob','Overstaffed_Prob','Overstaffed Probability'])),
                id: `${dateStr}::${deptStr || ''}`
              };
            }).filter(r => r.Date);
            // Sort ascending by date
            normalized.sort((a, b) => new Date(a.Date) - new Date(b.Date));
            setRows(normalized);
          } catch (err) {
            console.error(err);
            setError(err.message || String(err));
          } finally {
            setLoading(false);
          }
        }, []);

        // Initial and periodic loading
        React.useEffect(() => { load(); }, [load]);
        React.useEffect(() => {
          if (!POLL_MS) return;
          const timer = setInterval(load, POLL_MS);
          return () => clearInterval(timer);
        }, [load]);

        // Derived lists for filters and charts
        const departments = React.useMemo(() => ['All', ...unique(rows.map(r => r.Department || 'Unspecified'))], [rows]);
        // Filter by date range
        const dateFiltered = React.useMemo(() => {
          const from = dayjs(dateFrom).startOf('day');
          const to = dayjs(dateTo).endOf('day');
          return rows.filter(r => {
            const d = dayjs(r.Date);
            return d.isAfter(from.subtract(1, 'ms')) && d.isBefore(to.add(1, 'ms'));
          });
        }, [rows, dateFrom, dateTo]);
        // Filter by department
        const filtered = React.useMemo(() => dateFiltered.filter(r => dept === 'All' || (r.Department || 'Unspecified') === dept), [dateFiltered, dept]);

        // KPIs (aggregates over filtered data)
        const kpis = React.useMemo(() => {
          if (!filtered.length) return null;
          const totalSales = sum(filtered, r => r['Sales ($)']);
          const totalUnits = sum(filtered, r => (r['Sales Quantity (Units/2.2 lbs)'] !== null && r['Sales Quantity (Units/2.2 lbs)'] !== undefined) ? r['Sales Quantity (Units/2.2 lbs)'] : r['Sales Quantity']);
          const totalHours = sum(filtered, r => r['Net Hours']);
          const totalPEPHours = sum(filtered, r => r['Net Hours PEP']);
          const prod = totalHours ? totalUnits / totalHours : null;
          const hoursDeltaPct = totalPEPHours ? ((totalHours - totalPEPHours) / totalPEPHours) * 100 : null;
          const totalCustomers = sum(filtered, r => r['Customers']);
          const basket = totalCustomers ? totalSales / totalCustomers : null;
          // Forecast KPI: aggregate forecast (if present)
          const totalForecast = sum(filtered, r => r['Sales Forecast']);
          return { totalSales, totalUnits, totalHours, prod, hoursDeltaPct, totalCustomers, basket, totalForecast };
        }, [filtered]);

        // Time-series data aggregated by period (day or week)
        const tsData = React.useMemo(() => {
          const byKey = groupBy(filtered, r => {
            const d = dayjs(r.Date);
            return groupByPeriod === 'week' ? d.startOf('week').format('YYYY-MM-DD') : d.format('YYYY-MM-DD');
          });
          return Object.entries(byKey).map(([period, arr]) => {
            const sales = sum(arr, r => r['Sales ($)']);
            const units = sum(arr, r => (r['Sales Quantity (Units/2.2 lbs)'] !== null && r['Sales Quantity (Units/2.2 lbs)'] !== undefined) ? r['Sales Quantity (Units/2.2 lbs)'] : r['Sales Quantity']);
            const hours = sum(arr, r => r['Net Hours']);
            const prod = hours ? units / hours : 0;
            const forecast = sum(arr, r => r['Sales Forecast']);
            return { period, sales, units, hours, prod, forecast };
          }).sort((a, b) => new Date(a.period) - new Date(b.period));
        }, [filtered, groupByPeriod]);

        // Pie data: sales by department
        const pieData = React.useMemo(() => {
          const byDept = groupBy(filtered, r => r.Department || 'Unspecified');
          return Object.entries(byDept).map(([name, arr]) => ({ name, value: sum(arr, r => r['Sales ($)']) }))
            .sort((a, b) => b.value - a.value);
        }, [filtered]);

        // Render
        return (
          <div className="max-w-7xl mx-auto p-4 md:p-6">
            <header className="flex flex-col md:flex-row items-start md:items-center justify-between gap-4 mb-6">
              <div>
                <h1 className="text-2xl md:text-3xl font-bold">Lidl KPI Dashboard</h1>
                <p className="text-gray-600">Live data from Google Sheets with optional R analysis. Auto-refreshes every {POLL_MS/1000}s.</p>
              </div>
              <a href="#setup" className="text-sm text-blue-600 underline">Setup guide ↓</a>
            </header>

            {/* Filters */}
            <section className="card mb-6">
              <div className="grid grid-cols-2 md:grid-cols-5 gap-4 items-end">
                <div>
                  <label className="block text-sm text-gray-600 mb-1">From</label>
                  <input type="date" className="w-full border rounded-lg p-2" value={dateFrom} onChange={e => setDateFrom(e.target.value)} />
                </div>
                <div>
                  <label className="block text-sm text-gray-600 mb-1">To</label>
                  <input type="date" className="w-full border rounded-lg p-2" value={dateTo} onChange={e => setDateTo(e.target.value)} />
                </div>
                <div>
                  <label className="block text-sm text-gray-600 mb-1">Department</label>
                  <select className="w-full border rounded-lg p-2" value={dept} onChange={e => setDept(e.target.value)}>
                    {departments.map(d => <option key={d} value={d}>{d}</option>)}
                  </select>
                </div>
                <div>
                  <label className="block text-sm text-gray-600 mb-1">Group by</label>
                  <select className="w-full border rounded-lg p-2" value={groupByPeriod} onChange={e => setGroupByPeriod(e.target.value)}>
                    <option value="day">Day</option>
                    <option value="week">Week</option>
                  </select>
                </div>
                <div className="text-right">
                  <button onClick={() => load()} className="px-4 py-2 rounded-xl border hover:bg-gray-50">Sync now</button>
                </div>
              </div>
            </section>

            {/* Error message */}
            {error && (
              <div className="mb-4 bg-rose-50 text-rose-700 border border-rose-200 rounded-xl p-3">
                <strong>Error:</strong> {error}
              </div>
            )}

            {/* KPI cards */}
            <section className="grid grid-cols-1 md:grid-cols-3 lg:grid-cols-6 gap-4 mb-6">
              <div className="card"><div className="metric">{kpis ? money(kpis.totalSales) : '—'}</div><div className="metric-label">Sales</div></div>
              <div className="card"><div className="metric">{kpis ? num(kpis.totalUnits) : '—'}</div><div className="metric-label">Units</div></div>
              <div className="card"><div className="metric">{kpis ? num(kpis.totalHours, 1) : '—'}</div><div className="metric-label">Net Hours</div></div>
              <div className="card"><div className="metric">{kpis && kpis.prod != null ? num(kpis.prod, 2) : '—'}</div><div className="metric-label">Prod (Units/Hour)</div></div>
              <div className="card"><div className="metric">{kpis && kpis.hoursDeltaPct != null ? pct(kpis.hoursDeltaPct) : '—'}</div><div className="metric-label">Δ Hours vs PEP</div></div>
              <div className="card"><div className="metric">{kpis && kpis.basket != null ? money(kpis.basket) : '—'}</div><div className="metric-label">Avg Basket</div></div>
              {/* Forecast KPI only if present */}
              {kpis && kpis.totalForecast > 0 && (
                <div className="card"><div className="metric">{money(kpis.totalForecast)}</div><div className="metric-label">Forecast</div></div>
              )}
            </section>

            {/* Charts */}
            <section className="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
              <div className="card h-80">
                <h3 className="font-semibold mb-3">Sales vs Forecast</h3>
                <ResponsiveContainer width="100%" height="100%">
                  <AreaChart data={tsData} margin={{ top: 10, right: 20, bottom: 0, left: 0 }}>
                    <defs>
                      <linearGradient id="colorSales" x1="0" y1="0" x2="0" y2="1">
                        <stop offset="5%" stopColor="#3b82f6" stopOpacity={0.35}/>
                        <stop offset="95%" stopColor="#3b82f6" stopOpacity={0}/>
                      </linearGradient>
                    </defs>
                    <CartesianGrid strokeDasharray="3 3" />
                    <XAxis dataKey="period" />
                    <YAxis />
                    <Tooltip formatter={value => money(value)} />
                    <Area type="monotone" dataKey="sales" stroke="#3b82f6" fillOpacity={1} fill="url(#colorSales)" name="Sales" />
                    {/* Forecast line if data exists */}
                    {tsData.some(d => d.forecast) && (
                      <Line type="monotone" dataKey="forecast" stroke="#ef4444" dot={false} name="Forecast" />
                    )}
                  </AreaChart>
                </ResponsiveContainer>
              </div>
              <div className="card h-80">
                <h3 className="font-semibold mb-3">Units vs Hours (Productivity)</h3>
                <ResponsiveContainer width="100%" height="100%">
                  <ScatterChart margin={{ top: 10, right: 20, bottom: 0, left: 0 }}>
                    <CartesianGrid strokeDasharray="3 3" />
                    <XAxis dataKey="hours" name="Hours" />
                    <YAxis dataKey="units" name="Units" />
                    <Tooltip cursor={{ strokeDasharray: '3 3' }} />
                    <Legend />
                    <Scatter name="Daily" data={tsData.map(d => ({ hours: d.hours, units: d.units }))} fill="#10b981" />
                  </ScatterChart>
                </ResponsiveContainer>
              </div>
              <div className="card h-80">
                <h3 className="font-semibold mb-3">Net Hours by Period</h3>
                <ResponsiveContainer width="100%" height="100%">
                  <BarChart data={tsData}>
                    <CartesianGrid strokeDasharray="3 3" />
                    <XAxis dataKey="period" />
                    <YAxis />
                    <Tooltip />
                    <Bar dataKey="hours" fill="#6366f1" name="Net Hours" />
                  </BarChart>
                </ResponsiveContainer>
              </div>
              <div className="card h-80">
                <h3 className="font-semibold mb-3">Sales Share by Department</h3>
                <ResponsiveContainer width="100%" height="100%">
                  <PieChart>
                    <Tooltip formatter={value => money(value)} />
                    <Legend />
                    <Pie data={pieData} dataKey="value" nameKey="name" outerRadius={110}>
                      {pieData.map((entry, index) => (
                        <Cell key={`cell-${index}`} />
                      ))}
                    </Pie>
                  </PieChart>
                </ResponsiveContainer>
              </div>
            </section>

            {/* Table */}
            <section className="card mb-10 overflow-x-auto">
              <h3 className="font-semibold mb-3">Recent Rows</h3>
              <table className="min-w-full text-sm">
                <thead className="text-left text-gray-600">
                  <tr>
                    <th className="py-2 pr-4">Date</th>
                    <th className="py-2 pr-4">Department</th>
                    <th className="py-2 pr-4">Sales ($)</th>
                    <th className="py-2 pr-4">Units</th>
                    <th className="py-2 pr-4">Net Hours</th>
                    <th className="py-2 pr-4">Net Hours PEP</th>
                    <th className="py-2 pr-4">Δ Hours vs PEP</th>
                    {ANALYSIS_CSV_URL && (
                      <>
                        <th className="py-2 pr-4">Forecast</th>
                        <th className="py-2 pr-4">Overstaffed Prob</th>
                      </>
                    )}
                  </tr>
                </thead>
                <tbody>
                  {loading ? (
                    <tr><td className="py-6 text-gray-500" colSpan={ANALYSIS_CSV_URL ? 9 : 7}>Loading…</td></tr>
                  ) : (
                    filtered.length ? (
                      filtered.slice(-25).map(r => (
                        <tr key={r.id} className="border-t">
                          <td className="py-2 pr-4">{dayjs(r.Date).format('YYYY-MM-DD')}</td>
                          <td className="py-2 pr-4">{r.Department || '—'}</td>
                          <td className="py-2 pr-4">{money(r['Sales ($)'])}</td>
                          <td className="py-2 pr-4">{num((r['Sales Quantity (Units/2.2 lbs)'] !== null && r['Sales Quantity (Units/2.2 lbs)'] !== undefined) ? r['Sales Quantity (Units/2.2 lbs)'] : r['Sales Quantity'])}</td>
                          <td className="py-2 pr-4">{num(r['Net Hours'], 1)}</td>
                          <td className="py-2 pr-4">{num(r['Net Hours PEP'], 1)}</td>
                          <td className="py-2 pr-4">{
                            (() => {
                              const a = toNumber(r['Net Hours']);
                              const b = toNumber(r['Net Hours PEP']);
                              if (!a || !b) return '—';
                              return pct(((a - b) / b) * 100, 1);
                            })()
                          }</td>
                          {ANALYSIS_CSV_URL && (
                            <>
                              <td className="py-2 pr-4">{num(r['Sales Forecast'])}</td>
                              <td className="py-2 pr-4">{r['Overstaffed Prob'] == null ? '—' : (r['Overstaffed Prob'] * 100).toFixed(1) + '%'}</td>
                            </>
                          )}
                        </tr>
                      ))
                    ) : (
                      <tr><td className="py-6 text-gray-500" colSpan={ANALYSIS_CSV_URL ? 9 : 7}>No rows in this range.</td></tr>
                    )
                  )}
                </tbody>
              </table>
            </section>

            {/* Setup guide */}
            <section id="setup" className="card prose max-w-none">
              <h2 className="text-xl font-semibold">Setup Guide</h2>
              <ol className="list-decimal pl-5">
                <li><strong>Prepare your Sheets:</strong> Your raw tab should have columns like <code>Date</code>, <code>Department</code>, <code>Sales ($)</code>, <code>Sales Quantity (Units/2.2 lbs)</code>, <code>Customers</code>, <code>Net Hours</code>, <code>Net Hours PEP</code>, etc. The optional analysis tab should include <code>Sales Forecast</code> and <code>Overstaffed Prob</code> for the same dates/departments.</li>
                <li><strong>Publish each tab to CSV:</strong> In Google Sheets, choose File → Share → Publish to web, select each tab and choose "Comma‑separated values (.csv)", then copy the URL. Paste these into <code>RAW_CSV_URL</code> and <code>ANALYSIS_CSV_URL</code> at the top of this file.</li>
                <li><strong>Host the file:</strong> Save this HTML as <code>index.html</code> in a GitHub repository. Enable GitHub Pages (Settings → Pages → Deploy from a branch). The site will be served from <code>https://&lt;your‑username&gt;.github.io/&lt;your‑repo&gt;/</code>.</li>
                <li><strong>Update your data:</strong> Any edits in your published sheets will reflect here automatically on the next refresh. To incorporate new R outputs, re‑publish the analysis tab and update <code>ANALYSIS_CSV_URL</code> if necessary.</li>
              </ol>
              <p className="text-gray-600 text-sm">Tip: Keep your sheet unlisted and publish only the necessary tabs. Do not include sensitive information.</p>
            </section>

            <footer className="mt-10 text-center text-sm text-gray-500 pb-8">© {new Date().getFullYear()} Lidl Analysis Dashboard</footer>
          </div>
        );
      }

      // Render the app
      function Root() {
        return <App />;
      }
      const root = ReactDOM.createRoot(document.getElementById('root'));
      root.render(<Root />);
    </script>
  </body>
</html>
